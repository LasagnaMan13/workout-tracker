<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#3b82f6">
  <title>Advanced Workout Tracker</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icon.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    /* Minified Tailwind CSS (generated via Tailwind CLI) */
    *,::before,::after{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::before,::after{--tw-content:''}html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:Inter,ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}ul{list-style-position:inside}*{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000}*{--tw-shadow-color:0 0 #0000}.min-h-screen{min-height:100vh}.min-h-\[300px\]{min-height:300px}.mx-auto{margin-left:auto;margin-right:auto}.mb-2{margin-bottom:.5rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.ml-4{margin-left:1rem}.block{display:block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-full{height:100%}.w-full{width:100%}.max-w-5xl{max-width:80rem}.flex-col{flex-direction:column}.items-center{align-items:center}.space-x-4>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem * calc(1 - var(--tw-space-x-reverse)));margin-left:calc(1rem * var(--tw-space-x-reverse))}.space-y-2>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(.5rem * var(--tw-space-y-reverse))}.space-y-4>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-6>:not([hidden])~:not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem * var(--tw-space-y-reverse))}.overflow-x-auto{overflow-x:auto}.rounded-lg{border-radius:.5rem}.rounded-xl{border-radius:.75rem}.border{border-width:1px}.border-collapse{border-collapse:collapse}.border-gray-100{--tw-border-opacity:1;border-color:rgb(243 244 246 / var(--tw-border-opacity))}.border-gray-200{--tw-border-opacity:1;border-color:rgb(229 231 235 / var(--tw-border-opacity))}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity))}.bg-gray-50{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgb(229 231 235 / var(--tw-bg-opacity))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity))}.bg-blue-700{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity))}.bg-green-600{--tw-bg-opacity:1;background-color:rgb(22 163 74 / var(--tw-bg-opacity))}.bg-green-700{--tw-bg-opacity:1;background-color:rgb(21 128 61 / var(--tw-bg-opacity))}.bg-purple-600{--tw-bg-opacity:1;background-color:rgb(147 51 234 / var(--tw-bg-opacity))}.bg-purple-700{--tw-bg-opacity:1;background-color:rgb(126 34 206 / var(--tw-bg-opacity))}.bg-red-600{--tw-bg-opacity:1;background-color:rgb(220 38 38 / var(--tw-bg-opacity))}.bg-red-700{--tw-bg-opacity:1;background-color:rgb(185 28 28 / var(--tw-bg-opacity))}.bg-yellow-500{--tw-bg-opacity:1;background-color:rgb(234 179 8 / var(--tw-bg-opacity))}.bg-yellow-600{--tw-bg-opacity:1;background-color:rgb(202 138 4 / var(--tw-bg-opacity))}.bg-gray-600{--tw-bg-opacity:1;background-color:rgb(75 85 99 / var(--tw-bg-opacity))}.bg-gray-700{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity))}.p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.px-4{padding-left:1rem;padding-right:1rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.text-left{text-align:left}.text-center{text-align:center}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.font-medium{font-weight:500}.font-semibold{font-weight:600}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39 / var(--tw-text-opacity))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity))}.shadow{--tw-shadow:0 1px 3px 0 rgb(0 0 0 / .1), 0 1px 2px -1px rgb(0 0 0 / .1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color), 0 1px 2px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px rgb(0 0 0 / .1), 0 2px 4px -2px rgb(0 0 0 / .1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:150ms}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity))}.hover\:bg-green-700:hover{--tw-bg-opacity:1;background-color:rgb(21 128 61 / var(--tw-bg-opacity))}.hover\:bg-purple-700:hover{--tw-bg-opacity:1;background-color:rgb(126 34 206 / var(--tw-bg-opacity))}.hover\:bg-red-700:hover{--tw-bg-opacity:1;background-color:rgb(185 28 28 / var(--tw-bg-opacity))}.hover\:bg-yellow-600:hover{--tw-bg-opacity:1;background-color:rgb(202 138 4 / var(--tw-bg-opacity))}.hover\:bg-gray-50:hover{--tw-bg-opacity:1;background-color:rgb(249 250 251 / var(--tw-bg-opacity))}.hover\:bg-gray-700:hover{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity))}.focus\:border-blue-500:focus{--tw-border-opacity:1;border-color:rgb(59 130 246 / var(--tw-border-opacity))}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(3px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow,0 0 #0000)}@media (min-width:640px){.sm\:min-h-\[400px\]{min-height:400px}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.sm\:p-8{padding:2rem}.sm\:px-6{padding-left:1.5rem;padding-right:1.5rem}.sm\:py-3{padding-top:.75rem;padding-bottom:.75rem}.sm\:text-base{font-size:1rem;line-height:1.5rem}}@media (min-width:768px){.md\:grid-cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}}

    /* Custom styles for enhanced visual appeal and mobile optimization */
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom, #f3f4f6, #e5e7eb);
    }
    .section-card {
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .section-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }
    .btn {
      transition: background-color 0.3s ease, transform 0.1s ease;
      touch-action: manipulation;
      min-height: 48px; /* Larger touch target for mobile */
    }
    .btn:hover {
      transform: scale(1.05);
    }
    .input-field {
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      min-height: 48px; /* Larger touch target for mobile */
      font-size: 1rem; /* Ensure readable input text */
    }
    .input-field:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
      outline: none;
    }
    .chart-container {
      background: #ffffff;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .workout-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    @media (max-width: 639px) {
      .workout-table {
        display: none; /* Hide table on mobile */
      }
      .workout-cards {
        display: block; /* Show cards on mobile */
      }
    }
    @media (min-width: 640px) {
      .workout-table {
        display: table; /* Show table on desktop */
      }
      .workout-cards {
        display: none; /* Hide cards on desktop */
      }
      .chart-container {
        height: 400px; /* Restore fixed height for desktop */
      }
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAZYX7jrN8MIv3Pu7I79S1Qm8nyc0eyroc",
      authDomain: "workout-tracker-130ff.firebaseapp.com",
      projectId: "workout-tracker-130ff",
      storageBucket: "workout-tracker-130ff.appspot.com",
      messagingSenderId: "909959809525",
      appId: "1:909959809525:web:7288e82e028313cd5f78bc",
      databaseURL: "https://workout-tracker-130ff-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

</head>
<body class="min-h-screen p-6 sm:p-8">
  <div class="max-w-5xl mx-auto">
    <!-- Header -->
    <header class="text-center mb-8">
      <h1 class="text-4xl font-extrabold text-gray-900">Advanced Workout Tracker</h1>
      <p class="text-gray-600 mt-2">Track your progress, set new PRs, and generate custom workouts!</p>
    </header>

    <!-- Add/Edit Workout -->
    <div class="section-card bg-white p-6 rounded-xl shadow-md mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-4" id="formTitle">Add Workout</h2>
      <div id="exerciseEntries" class="space-y-4">
        <div class="exercise-entry grid grid-cols-1 md:grid-cols-5 gap-4">
          <input type="text" placeholder="Exercise (e.g., Bench Press)" class="exercise-name input-field border border-gray-300 p-2 rounded-lg text-gray-700" required>
          <input type="number" placeholder="Sets" class="sets input-field border border-gray-300 p-2 rounded-lg text-gray-700" required min="1">
          <div class="set-details space-y-2">
            <div class="set-entry grid grid-cols-2 gap-2">
              <input type="number" placeholder="Reps" class="reps input-field border border-gray-300 p-2 rounded-lg text-gray-700" required min="1">
              <input type="number" placeholder="Weight (lbs)" class="weight input-field border border-gray-300 p-2 rounded-lg text-gray-700" required min="0">
            </div>
          </div>
          <button class="add-set btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add Set</button>
          <button class="undo-set btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 hidden">Undo Add Set</button>
        </div>
      </div>
      <div class="flex space-x-4 mt-6">
        <button id="addExercise" class="btn bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Add Another Exercise</button>
        <button id="submitWorkout" class="btn bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Submit Workout</button>
        <button id="cancelEdit" class="btn bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 hidden">Cancel Edit</button>
      </div>
    </div>

    <!-- Filter Workouts -->
    <div class="section-card bg-white p-6 rounded-xl shadow-md mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Filter Workouts</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <input type="date" id="startDate" class="input-field border border-gray-300 p-2 rounded-lg text-gray-700">
        <input type="date" id="endDate" class="input-field border border-gray-300 p-2 rounded-lg text-gray-700">
        <select id="exerciseFilter" class="input-field border border-gray-300 p-2 rounded-lg text-gray-700">
          <option value="">All Exercises</option>
        </select>
      </div>
      <div class="flex space-x-4 mt-6">
        <button id="filterBtn" class="btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Filter</button>
        <button id="resetBtn" class="btn bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Reset</button>
      </div>
    </div>

    <!-- PR Summary -->
    <div class="section-card bg-white p-6 rounded-xl shadow-md mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Personal Records (PRs)</h2>
      <div id="prSummary" class="space-y-2 text-gray-700"></div>
    </div>

    <!-- Weekly/Monthly Stats -->
    <div class="section-card bg-white p-6 rounded-xl shadow-md mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Weekly & Monthly Stats</h2>
      <div id="statsSummary" class="space-y-2 text-gray-700"></div>
    </div>

    <!-- Workout History -->
    <div class="section-card bg-white p-6 rounded-xl shadow-md mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Workout History</h2>
      <div class="workout-table overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-100 text-gray-800">
              <th class="border border-gray-200 p-3 text-left">Exercise</th>
              <th class="border border-gray-200 p-3 text-left">Sets</th>
              <th class="border border-gray-200 p-3 text-left">Reps</th>
              <th class="border border-gray-200 p-3 text-left">Weight</th>
              <th class="border border-gray-200 p-3 text-left">Date</th>
              <th class="border border-gray-200 p-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="workoutTable" class="text-gray-700"></tbody>
        </table>
      </div>
      <div id="workoutCards" class="workout-cards space-y-4"></div>
    </div>

    <!-- Progress Charts -->
    <div class="section-card bg-white p-6 rounded-xl shadow-md mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Progress Charts</h2>
      <div class="chart-container relative min-h-[300px] sm:min-h-[400px]">
        <canvas id="progressChart"></canvas>
      </div>
    </div>

    <!-- Custom WOD Generator -->
    <div class="section-card bg-white p-6 rounded-xl shadow-md">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Custom WOD Generator</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block mb-2 text-gray-700 font-medium">Select Difficulty</label>
          <select id="difficulty" class="input-field border border-gray-300 p-2 rounded-lg w-full text-gray-700">
            <option value="easy">Easy</option>
            <option value="moderate">Moderate</option>
            <option value="hard">Hard</option>
          </select>
        </div>
        <div>
          <label class="block mb-2 text-gray-700 font-medium">Select Equipment</label>
          <select id="equipment" class="input-field border border-gray-300 p-2 rounded-lg w-full text-gray-700">
            <option value="bodyweight">Bodyweight</option>
            <option value="dumbbell">Dumbbell</option>
            <option value="barbell">Barbell</option>
          </select>
        </div>
      </div>
      <button id="generateWOD" class="btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 mt-6">Generate WOD</button>
      <div id="wodResult" class="mt-4 text-gray-700"></div>
    </div>
  </div>

  <script>
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js', { scope: '/' })
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.error('Service Worker registration failed:', err));
    }

    // Initialize workouts from localStorage
    let workouts = JSON.parse(localStorage.getItem('workouts')) || [];
    let editIndex = null;

    // Add exercise entry
    document.getElementById('addExercise').addEventListener('click', () => {
      const entry = document.createElement('div');
      entry.className = 'exercise-entry grid grid-cols-1 md:grid-cols-5 gap-4';
      entry.innerHTML = `
        <input type="text" placeholder="Exercise (e.g., Bench Press)" class="exercise-name input-field border border-gray-300 p-2 rounded-lg text-gray-700" required>
        <input type="number" placeholder="Sets" class="sets input-field border border-gray-300 p-2 rounded-lg text-gray-700" required min="1">
        <div class="set-details space-y-2">
          <div class="set-entry grid grid-cols-2 gap-2">
            <input type="number" placeholder="Reps" class="reps input-field border border-gray-300 p-2 rounded-lg text-gray-700" required min="1">
            <input type="number" placeholder="Weight (lbs)" class="weight input-field border border-gray-300 p-2 rounded-lg text-gray-700" required min="0">
          </div>
        </div>
        <button class="add-set btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add Set</button>
        <button class="undo-set btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 hidden">Undo Add Set</button>
      `;
      document.getElementById('exerciseEntries').appendChild(entry);
    });

    // Add and undo set
    document.getElementById('exerciseEntries').addEventListener('click', (e) => {
      if (e.target.classList.contains('add-set')) {
        const setDetails = e.target.previousElementSibling;
        const undoBtn = e.target.nextElementSibling;
        const setEntry = document.createElement('div');
        setEntry.className = 'set-entry grid grid-cols-2 gap-2';
        setEntry.innerHTML = `
          <input type="number" placeholder="Reps" class="reps input-field border border-gray-300 p-2 rounded-lg text-gray-700" required min="1">
          <input type="number" placeholder="Weight (lbs)" class="weight input-field border border-gray-300 p-2 rounded-lg text-gray-700" required min="0">
        `;
        setDetails.appendChild(setEntry);
        undoBtn.classList.remove('hidden');
      } else if (e.target.classList.contains('undo-set')) {
        const setDetails = e.target.previousElementSibling.previousElementSibling;
        const lastSet = setDetails.lastChild;
        if (lastSet && setDetails.children.length > 1) {
          lastSet.remove();
        }
        if (setDetails.children.length === 1) {
          e.target.classList.add('hidden');
        }
      }
    });

    // Submit or update workout
    document.getElementById('submitWorkout').addEventListener('click', () => {
      const entries = document.querySelectorAll('.exercise-entry');
      const newWorkout = { date: new Date().toISOString().split('T')[0], exercises: [] };

      entries.forEach(entry => {
        const exerciseName = entry.querySelector('.exercise-name').value;
        const sets = parseInt(entry.querySelector('.sets').value);
        const setDetails = entry.querySelectorAll('.set-entry');
        const setData = Array.from(setDetails).map(set => ({
          reps: parseInt(set.querySelector('.reps').value),
          weight: parseInt(set.querySelector('.weight').value)
        }));

        if (exerciseName && sets && setData.length > 0) {
          newWorkout.exercises.push({ name: exerciseName, sets, setData });
        }
      });

      if (newWorkout.exercises.length > 0) {
        if (editIndex !== null) {
          workouts[editIndex] = newWorkout;
          editIndex = null;
          document.getElementById('formTitle').textContent = 'Add Workout';
          document.getElementById('cancelEdit').classList.add('hidden');
          document.getElementById('submitWorkout').textContent = 'Submit Workout';
        } else {
          workouts.push(newWorkout);
        }
        localStorage.setItem('workouts', JSON.stringify(workouts));
        updateUI();
        resetForm();
      }
    });

    // Cancel edit
    document.getElementById('cancelEdit').addEventListener('click', () => {
      editIndex = null;
      document.getElementById('formTitle').textContent = 'Add Workout';
      document.getElementById('cancelEdit').classList.add('hidden');
      document.getElementById('submitWorkout').textContent = 'Submit Workout';
      resetForm();
    });

    // Reset form
    function resetForm() {
      const entries = document.querySelectorAll('.exercise-entry');
      entries.forEach(entry => entry.remove());
      document.getElementById('exerciseEntries').innerHTML = `
        <div class="exercise-entry grid grid-cols-1 md:grid-cols-5 gap-4">
          <input type="text" placeholder="Exercise (e.g., Bench Press)" class="exercise-name input-field border border-gray-300 p-2 rounded-lg text-gray-700" required>
          <input type="number" placeholder="Sets" class="sets input-field border border-gray-300 p-2 rounded-lg text-gray-700" required min="1">
          <div class="set-details space-y-2">
            <div class="set-entry grid grid-cols-2 gap-2">
              <input type="number" placeholder="Reps" class="reps input-field border border-gray-300 p-2 rounded-lg text-gray-700" required min="1">
              <input type="number" placeholder="Weight (lbs)" class="weight input-field border border-gray-300 p-2 rounded-lg text-gray-700" min="0">
            </div>
          </div>
          <button class="add-set btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add Set</button>
          <button class="undo-set btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 hidden">Undo Add Set</button>
        </div>
      `;
    }

    // Filter workouts
    document.getElementById('filterBtn').addEventListener('click', () => {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const exercise = document.getElementById('exerciseFilter').value;
      updateUI(startDate, endDate, exercise);
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('exerciseFilter').value = '';
      updateUI();
    });

    // Edit or delete workout
    document.getElementById('workoutTable').addEventListener('click', (e) => {
      const workoutIndex = parseInt(e.target.dataset.workoutIndex);
      const exerciseName = e.target.dataset.exerciseName;
      if (e.target.classList.contains('edit-btn')) {
        editWorkout(workoutIndex, exerciseName);
      } else if (e.target.classList.contains('delete-btn')) {
        deleteWorkout(workoutIndex, exerciseName);
      }
    });

    document.getElementById('workoutCards').addEventListener('click', (e) => {
      const workoutIndex = parseInt(e.target.dataset.workoutIndex);
      const exerciseName = e.target.dataset.exerciseName;
      if (e.target.classList.contains('edit-btn')) {
        editWorkout(workoutIndex, exerciseName);
      } else if (e.target.classList.contains('delete-btn')) {
        deleteWorkout(workoutIndex, exerciseName);
      }
    });

    // Edit workout
    function editWorkout(workoutIndex, exerciseName) {
      const workout = workouts[workoutIndex];
      editIndex = workoutIndex;
      document.getElementById('formTitle').textContent = 'Edit Workout';
      document.getElementById('submitWorkout').textContent = 'Update Workout';
      document.getElementById('cancelEdit').classList.remove('hidden');

      const entries = document.querySelectorAll('.exercise-entry');
      entries.forEach(entry => entry.remove());
      const exerciseEntries = document.getElementById('exerciseEntries');

      workout.exercises.forEach(ex => {
        if (!exerciseName || ex.name === exerciseName) {
          const entry = document.createElement('div');
          entry.className = 'exercise-entry grid grid-cols-1 md:grid-cols-5 gap-4';
          let setDetailsHtml = '';
          ex.setData.forEach(set => {
            setDetailsHtml += `
              <div class="set-entry grid grid-cols-2 gap-2">
                <input type="number" value="${set.reps}" class="reps input-field border border-gray-300 p-2 rounded-lg text-gray-700" required min="1">
                <input type="number" value="${set.weight}" class="weight input-field border border-gray-300 p-2 rounded-lg text-gray-700" required min="0">
              </div>
            `;
          });
          entry.innerHTML = `
            <input type="text" value="${ex.name}" class="exercise-name input-field border border-gray-300 p-2 rounded-lg text-gray-700" required>
            <input type="number" value="${ex.sets}" class="sets input-field border border-gray-300 p-2 rounded-lg text-gray-700" required min="1">
            <div class="set-details space-y-2">
              ${setDetailsHtml}
            </div>
            <button class="add-set btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add Set</button>
            <button class="undo-set btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 ${ex.setData.length > 1 ? '' : 'hidden'}">Undo Add Set</button>
          `;
          exerciseEntries.appendChild(entry);
        }
      });
    }

    // Delete workout
    function deleteWorkout(workoutIndex, exerciseName) {
      if (confirm('Are you sure you want to delete this workout?')) {
        if (exerciseName) {
          workouts[workoutIndex].exercises = workouts[workoutIndex].exercises.filter(ex => ex.name !== exerciseName);
          if (workouts[workoutIndex].exercises.length === 0) {
            workouts.splice(workoutIndex, 1);
          }
        } else {
          workouts.splice(workoutIndex, 1);
        }
        localStorage.setItem('workouts', JSON.stringify(workouts));
        updateUI();
      }
    }

    // Generate WOD
    document.getElementById('generateWOD').addEventListener('click', () => {
      const difficulty = document.getElementById('difficulty').value;
      const equipment = document.getElementById('equipment').value;
      const wod = generateWOD(difficulty, equipment);
      document.getElementById('wodResult').innerHTML = `<div class="p-4 bg-gray-50 rounded-lg text-gray-700">${wod}</div>`;
    });

    // Chart initialization
    let chartInstance = null;
    function updateChart(filteredWorkouts, exerciseFilter) {
      const ctx = document.getElementById('progressChart').getContext('2d');
      const exerciseData = {};
      filteredWorkouts.forEach(workout => {
        workout.exercises.forEach(ex => {
          if (!exerciseFilter || ex.name === exerciseFilter) {
            if (!exerciseData[ex.name]) exerciseData[ex.name] = [];
            ex.setData.forEach(set => {
              exerciseData[ex.name].push({
                date: workout.date,
                weight: set.weight,
                reps: set.reps
              });
            });
          }
        });
      });

      const datasets = Object.keys(exerciseData).map(name => ({
        label: name,
        data: exerciseData[name].map(d => ({ x: new Date(d.date), y: d.weight })),
        borderColor: getRandomColor(),
        fill: false,
        tension: 0.1
      }));

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: { unit: 'day' },
              adapters: { date: { locale: window.dateFnsLocale } },
              title: { display: true, text: 'Date', font: { size: 14, weight: 'bold' } }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Weight (lbs)', font: { size: 14, weight: 'bold' } }
            }
          },
          plugins: {
            legend: { display: true, labels: { font: { size: 12 } } },
            tooltip: { mode: 'index', intersect: false }
          }
        }
      });
    }

    // Generate random color for chart
    function getRandomColor() {
      const colors = ['#3b82f6', '#10b981', '#f43f5e', '#8b5cf6', '#f59e0b', '#ec4899'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // Generate WOD
    function generateWOD(difficulty, equipment) {
      const exercises = {
        bodyweight: ['Push-ups', 'Squats', 'Burpees', 'Lunges', 'Plank'],
        dumbbell: ['Dumbbell Press', 'Dumbbell Rows', 'Goblet Squats', 'Dumbbell Lunges'],
        barbell: ['Deadlifts', 'Bench Press', 'Squats', 'Overhead Press']
      };
      const reps = { easy: '10-15', moderate: '15-20', hard: '20-30' };
      const sets = { easy: 3, moderate: 4, hard: 5 };
      const selectedExercises = exercises[equipment].sort(() => 0.5 - Math.random()).slice(0, 3);
      return `
        <h3 class="text-lg font-semibold text-gray-800">WOD (${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}, ${equipment.charAt(0).toUpperCase() + equipment.slice(1)})</h3>
        <ul class="list-disc ml-4">
          ${selectedExercises.map(ex => `<li>${sets[difficulty]} sets of ${reps[difficulty]} ${ex}</li>`).join('')}
        </ul>
      `;
    }

    // Update UI
    function updateUI(startDate = '', endDate = '', exerciseFilter = '') {
      const filteredWorkouts = workouts.filter(w => {
        const date = new Date(w.date);
        const start = startDate ? new Date(startDate) : new Date(0);
        const end = endDate ? new Date(endDate) : new Date();
        return date >= start && date <= end;
      });

      // Update exercise filter dropdown
      const exercises = new Set();
      workouts.forEach(w => w.exercises.forEach(e => exercises.add(e.name)));
      const exerciseFilterEl = document.getElementById('exerciseFilter');
      exerciseFilterEl.innerHTML = '<option value="">All Exercises</option>' +
        Array.from(exercises).map(e => `<option value="${e}">${e}</option>`).join('');

      // Update workout table
      const table = document.getElementById('workoutTable');
      table.innerHTML = '';
      const cards = document.getElementById('workoutCards');
      cards.innerHTML = '';
      filteredWorkouts.forEach((workout, index) => {
        const exerciseMap = {};
        workout.exercises.forEach(ex => {
          if (!exerciseFilter || ex.name === exerciseFilter) {
            if (!exerciseMap[ex.name]) {
              exerciseMap[ex.name] = { sets: ex.sets, setData: [], date: workout.date };
            }
            exerciseMap[ex.name].setData.push(...ex.setData);
          }
        });
        Object.keys(exerciseMap).forEach(name => {
          const ex = exerciseMap[name];
          const repsStr = ex.setData.map(set => set.reps).join('/');
          const weightStr = ex.setData.map(set => set.weight).join('/');
          // Table row for desktop
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="border border-gray-200 p-3">${name}</td>
            <td class="border border-gray-200 p-3">${ex.sets}</td>
            <td class="border border-gray-200 p-3">${repsStr}</td>
            <td class="border border-gray-200 p-3">${weightStr}</td>
            <td class="border border-gray-200 p-3">${ex.date}</td>
            <td class="border border-gray-200 p-3">
              <button class="edit-btn btn bg-yellow-500 text-white px-2 py-1 rounded-lg hover:bg-yellow-600 mr-2" data-workout-index="${index}" data-exercise-name="${name}">Edit</button>
              <button class="delete-btn btn bg-red-600 text-white px-2 py-1 rounded-lg hover:bg-red-700" data-workout-index="${index}" data-exercise-name="${name}">Delete</button>
            </td>
          `;
          table.appendChild(row);
          // Card for mobile
          const card = document.createElement('div');
          card.className = 'workout-card';
          card.innerHTML = `
            <div class="flex flex-col space-y-2">
              <div><strong>Exercise:</strong> ${name}</div>
              <div><strong>Sets:</strong> ${ex.sets}</div>
              <div><strong>Reps:</strong> ${repsStr}</div>
              <div><strong>Weight:</strong> ${weightStr}</div>
              <div><strong>Date:</strong> ${ex.date}</div>
              <div class="flex space-x-2">
                <button class="edit-btn btn bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600" data-workout-index="${index}" data-exercise-name="${name}">Edit</button>
                <button class="delete-btn btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700" data-workout-index="${index}" data-exercise-name="${name}">Delete</button>
              </div>
            </div>
          `;
          cards.appendChild(card);
        });
      });

      // Update PR summary
      const prSummary = document.getElementById('prSummary');
      prSummary.innerHTML = '';
      const prs = {};
      workouts.forEach(w => {
        w.exercises.forEach(ex => {
          if (!exerciseFilter || ex.name === exerciseFilter) {
            if (!prs[ex.name]) prs[ex.name] = { weight: 0, date: '' };
            ex.setData.forEach(set => {
              if (set.weight > prs[ex.name].weight) {
                prs[ex.name] = { weight: set.weight, date: w.date };
              }
            });
          }
        });
      });
      Object.keys(prs).forEach(ex => {
        prSummary.innerHTML += `<p>${ex}: ${prs[ex].weight} lbs on ${prs[ex].date}</p>`;
      });

      // Update weekly/monthly stats
      const statsSummary = document.getElementById('statsSummary');
      statsSummary.innerHTML = '';
      const weeklyStats = {}, monthlyStats = {};
      workouts.forEach(w => {
        const date = new Date(w.date);
        const week = `${date.getFullYear()}-W${Math.floor(date.getDate()/7)+1}`;
        const month = `${date.getFullYear()}-${date.getMonth()+1}`;
        if (!weeklyStats[week]) weeklyStats[week] = { totalWeight: 0, workouts: 0 };
        if (!monthlyStats[month]) monthlyStats[month] = { totalWeight: 0, workouts: 0 };
        w.exercises.forEach(ex => {
          if (!exerciseFilter || ex.name === exerciseFilter) {
            ex.setData.forEach(set => {
              weeklyStats[week].totalWeight += set.weight * set.reps;
              monthlyStats[month].totalWeight += set.weight * set.reps;
            });
            weeklyStats[week].workouts++;
            monthlyStats[month].workouts++;
          }
        });
      });
      statsSummary.innerHTML += '<h3 class="text-lg font-semibold text-gray-800">Weekly Stats</h3>';
      Object.keys(weeklyStats).forEach(week => {
        statsSummary.innerHTML += `<p>${week}: ${weeklyStats[week].workouts} workouts, ${weeklyStats[week].totalWeight} lbs lifted</p>`;
      });
      statsSummary.innerHTML += '<h3 class="text-lg font-semibold text-gray-800 mt-4">Monthly Stats</h3>';
      Object.keys(monthlyStats).forEach(month => {
        statsSummary.innerHTML += `<p>${month}: ${monthlyStats[month].workouts} workouts, ${monthlyStats[month].totalWeight} lbs lifted</p>`;
      });

      updateChart(filteredWorkouts, exerciseFilter);
    }

    // Initial UI update
    updateUI();
  </script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log("Service Worker registered"))
      .catch(err => console.error("SW registration failed:", err));
  }
</script>
</body>
</html>
