<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Workout Tracker</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js & date adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <!-- PWA manifest & favicon -->
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" href="icon.png" type="image/png"/>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAZYX7jrN8MIv3Pu7I79S1Qm8nyc0eyroc",
      authDomain: "workout-tracker-130ff.firebaseapp.com",
      databaseURL: "https://workout-tracker-130ff-default-rtdb.firebaseio.com",
      projectId: "workout-tracker-130ff",
      storageBucket: "workout-tracker-130ff.appspot.com",
      messagingSenderId: "909959809525",
      appId: "1:909959809525:web:7288e82e028313cd5f78bc"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-3xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4">Workout Tracker</h1>

    <!-- Workout Entry Form -->
    <section class="bg-white p-4 mb-6 rounded shadow">
      <form id="workoutForm">
        <div id="exercises"></div>
        <button type="button" id="addBtn" class="bg-blue-500 text-white px-4 py-2 rounded mb-2">Add Exercise</button>
        <button type="submit" id="saveBtn" class="bg-green-500 text-white px-4 py-2 rounded">Save Workout</button>
      </form>
    </section>

    <!-- Workout History -->
    <section class="bg-white p-4 mb-6 rounded shadow">
      <h2 class="text-2xl font-bold mb-2">History</h2>
      <div id="history"></div>
    </section>

    <!-- Personal Records -->
    <section class="bg-white p-4 mb-6 rounded shadow">
      <h2 class="text-2xl font-bold mb-2">Personal Records</h2>
      <ul id="prs" class="list-disc pl-5"></ul>
    </section>

    <!-- Progress Chart -->
    <section class="bg-white p-4 rounded shadow">
      <h2 class="text-2xl font-bold mb-2">Progress Chart</h2>
      <canvas id="chart"></canvas>
    </section>
  </div>

  <script>
    // References
    const exercisesDiv = document.getElementById('exercises');
    const historyDiv = document.getElementById('history');
    const prsUl = document.getElementById('prs');
    const chartCtx = document.getElementById('chart').getContext('2d');
    let workouts = [], keys = [], editKey = null, chart;

    // Add one exercise block
    function addExercise() {
      const div = document.createElement('div');
      div.className = 'mb-4';
      div.innerHTML = `
        <input class="exercise-name border p-2 w-full mb-2" placeholder="Exercise Name" />
        <input type="number" class="sets border p-2 mb-2" placeholder="Sets" min="1" />
        <div class="sets-container mb-2"></div>
        <button type="button" class="add-sets bg-blue-200 px-2 py-1 rounded mr-2">Add Sets</button>
        <button type="button" class="remove-exercise bg-red-200 px-2 py-1 rounded">Remove</button>
      `;
      exercisesDiv.appendChild(div);

      // Add sets inputs
      div.querySelector('.add-sets').addEventListener('click', () => {
        const count = parseInt(div.querySelector('.sets').value) || 0;
        const container = div.querySelector('.sets-container');
        container.innerHTML = '';
        for (let i = 0; i < count; i++) {
          const sdiv = document.createElement('div');
          sdiv.className = 'flex space-x-2 mb-2';
          sdiv.innerHTML = `
            <input type="number" class="reps border p-2 w-1/2" placeholder="Reps" min="1" />
            <input type="number" class="weight border p-2 w-1/2" placeholder="Weight" min="0" step="0.1" />
          `;
          container.appendChild(sdiv);
        }
      });

      // Remove exercise block
      div.querySelector('.remove-exercise').addEventListener('click', () => div.remove());
    }

    // Handlers
    document.getElementById('addBtn').addEventListener('click', addExercise);
    document.getElementById('workoutForm').addEventListener('submit', e => {
      e.preventDefault();
      const blocks = exercisesDiv.querySelectorAll('div.mb-4');
      const workout = { date: new Date().toISOString().split('T')[0], exercises: [] };
      blocks.forEach(block => {
        const name = block.querySelector('.exercise-name').value.trim();
        const setElems = block.querySelectorAll('.sets-container div');
        const sets = [];
        setElems.forEach(se => {
          const reps = parseInt(se.querySelector('.reps').value);
          const weight = parseFloat(se.querySelector('.weight').value);
          if (reps > 0) sets.push({ reps, weight });
        });
        if (name && sets.length) workout.exercises.push({ name, sets });
      });
      if (!workout.exercises.length) return;
      if (editKey) {
        db.ref('workouts/' + editKey).set(workout);
        editKey = null;
      } else {
        db.ref('workouts').push(workout);
      }
      exercisesDiv.innerHTML = '';
      addExercise();
      document.getElementById('workoutForm').reset();
    });

    // Render all sections
    function renderAll() {
      // History
      historyDiv.innerHTML = '';
      workouts.forEach((w, i) => {
        const div = document.createElement('div');
        div.className = 'mb-3 border-b pb-2';
        div.innerHTML = `
          <div class="flex justify-between">
            <span>${w.date}</span>
            <span>
              <button data-i="${i}" class="edit text-yellow-500 mr-2">Edit</button>
              <button data-i="${i}" class="del text-red-500">Delete</button>
            </span>
          </div>
          <div>${w.exercises.map(e => `<strong>${e.name}</strong>: ${e.sets.map(s => s.weight + 'x' + s.reps).join(', ')}`).join('<br>')}</div>
        `;
        historyDiv.appendChild(div);
      });

      // Edit/Delete events
      historyDiv.querySelectorAll('.edit').forEach(btn => {
        btn.onclick = () => {
          const idx = btn.dataset.i;
          editKey = keys[idx];
          const w = workouts[idx];
          exercisesDiv.innerHTML = '';
          w.exercises.forEach(e => {
            addExercise();
            const last = exercisesDiv.lastChild;
            last.querySelector('.exercise-name').value = e.name;
            last.querySelector('.sets').value = e.sets.length;
            last.querySelector('.add-sets').click();
            last.querySelectorAll('.sets-container div').forEach((sdiv, j) => {
              sdiv.querySelector('.reps').value = e.sets[j].reps;
              sdiv.querySelector('.weight').value = e.sets[j].weight;
            });
          });
        };
      });
      historyDiv.querySelectorAll('.del').forEach(btn => {
        btn.onclick = () => {
          const idx = btn.dataset.i;
          if (confirm('Delete this workout?')) db.ref('workouts/' + keys[idx]).remove();
        };
      });

      // Personal Records
      const pr = {};
      workouts.forEach(w => w.exercises.forEach(e => e.sets.forEach(s => {
        if (!pr[e.name] || s.weight > pr[e.name]) pr[e.name] = s.weight;
      })));
      prsUl.innerHTML = '';
      Object.entries(pr).forEach(([name, wt]) => {
        const li = document.createElement('li');
        li.textContent = `${name}: ${wt}`;
        prsUl.appendChild(li);
      });

      // Progress Chart
      const labels = workouts.map(w => w.date);
      const data = workouts.map(w => w.exercises.reduce((a, e) => a + e.sets.reduce((b, s) => b + s.reps * s.weight, 0), 0));
      if (chart) chart.destroy();
      chart = new Chart(chartCtx, { type: 'line', data: { labels, datasets: [{ label: 'Total Volume', data }] }, options: { scales: { x: { type: 'time', time: { unit: 'day' } } } } });
    }

    // Real-time DB listener
    db.ref('workouts').on('value', snap => {
      workouts = [];
      keys = [];
      snap.forEach(child => { keys.push(child.key); workouts.push(child.val()); });
      renderAll();
    });

    // Initialize
    addExercise();
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
  </script>
</body>
</html>
