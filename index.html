<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Workout Tracker</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js and date adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- PWA manifest & icon -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="/icon.png" type="image/png" />

  <!-- Firebase Compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAZYX7jrN8MIv3Pu7I79S1Qm8nyc0eyroc",
      authDomain: "workout-tracker-130ff.firebaseapp.com",
      databaseURL: "https://workout-tracker-130ff-default-rtdb.firebaseio.com",
      projectId: "workout-tracker-130ff",
      storageBucket: "workout-tracker-130ff.appspot.com",
      messagingSenderId: "909959809525",
      appId: "1:909959809525:web:7288e82e028313cd5f78bc"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-3xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4">Advanced Workout Tracker</h1>

    <!-- Workout Form -->
    <section id="workout-form" class="mb-6 bg-white p-4 rounded shadow">
      <form id="addWorkoutForm">
        <div id="exerciseContainer"></div>
        <button type="button" id="addExercise" class="bg-blue-500 text-white px-4 py-2 rounded mb-2">Add Exercise</button>
        <button type="submit" id="submitWorkout" class="bg-green-500 text-white px-4 py-2 rounded">Submit Workout</button>
      </form>
    </section>

    <!-- Workout History -->
    <section id="history" class="bg-white p-4 rounded shadow mb-6">
      <h2 class="text-2xl font-bold mb-2">Workout History</h2>
      <table class="min-w-full divide-y divide-gray-200 mb-4">
        <thead>
          <tr>
            <th class="px-4 py-2 text-left">Date</th>
            <th class="px-4 py-2 text-left">Exercises</th>
            <th class="px-4 py-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </section>

    <!-- PR Summary -->
    <section id="prSummary" class="bg-white p-4 rounded shadow mb-6">
      <h2 class="text-2xl font-bold mb-2">Personal Records</h2>
      <ul id="prList" class="list-disc pl-5"></ul>
    </section>

    <!-- Progress Chart -->
    <section id="chartSection" class="bg-white p-4 rounded shadow mb-6">
      <h2 class="text-2xl font-bold mb-2">Progress Chart (Total Volume)</h2>
      <canvas id="progressChart"></canvas>
    </section>
  </div>

  <script>
    let workouts = [];
    let workoutKeys = [];
    let editKey = null;

    // Real-time listener
    db.ref('workouts').on('value', snapshot => {
      workouts = [];
      workoutKeys = [];
      snapshot.forEach(childSnap => {
        workoutKeys.push(childSnap.key);
        workouts.push(childSnap.val());
      });
      renderHistory();
      renderPRs();
      renderChart();
    });

    // Add initial exercise entry
    document.getElementById('addExercise').addEventListener('click', addExerciseEntry);

    // Handle form submit
    document.getElementById('addWorkoutForm').addEventListener('submit', e => {
      e.preventDefault();
      const entries = document.querySelectorAll('.exercise-entry');
      const newWorkout = { date: new Date().toISOString().split('T')[0], exercises: [] };
      entries.forEach(entry => {
        const name = entry.querySelector('.exercise-name').value.trim();
        const setEls = entry.querySelectorAll('.set-entry');
        const setsData = Array.from(setEls).map(se => ({
          reps: parseInt(se.querySelector('.reps').value),
          weight: parseFloat(se.querySelector('.weight').value)
        }));
        if (name && setsData.length) newWorkout.exercises.push({ name, setsData });
      });
      if (!newWorkout.exercises.length) return;
      if (editKey) {
        db.ref(`workouts/${editKey}`).set(newWorkout);
        editKey = null;
      } else {
        db.ref('workouts').push(newWorkout);
      }
      document.getElementById('addWorkoutForm').reset();
      document.getElementById('exerciseContainer').innerHTML = '';
      addExerciseEntry();
    });

    // Functions
    function addExerciseEntry() {
      const container = document.getElementById('exerciseContainer');
      const entry = document.createElement('div');
      entry.className = 'exercise-entry mb-4';
      entry.innerHTML = `
        <input type="text" class="exercise-name border p-2 w-full mb-2" placeholder="Exercise Name" required />
        <input type="number" class="sets border p-2 mb-2" placeholder="Number of Sets" min="1" required />
        <div class="set-entries space-y-2 mb-2"></div>
        <button type="button" class="add-sets-btn bg-blue-200 px-2 py-1 rounded mr-2">Add Sets</button>
        <button type="button" class="remove-entry-btn bg-red-200 px-2 py-1 rounded">Remove</button>
      `;
      container.appendChild(entry);
      entry.querySelector('.add-sets-btn').addEventListener('click', () => {
        const count = parseInt(entry.querySelector('.sets').value);
        const setsDiv = entry.querySelector('.set-entries');
        setsDiv.innerHTML = '';
        for (let i = 0; i < count; i++) {
          const setEl = document.createElement('div');
          setEl.className = 'set-entry flex space-x-2';
          setEl.innerHTML = `
            <input type="number" class="reps border p-2 w-1/2" placeholder="Reps" min="1" required />
            <input type="number" class="weight border p-2 w-1/2" placeholder="Weight" min="0" step="0.1" required />
          `;
          setsDiv.appendChild(setEl);
        }
      });
      entry.querySelector('.remove-entry-btn').addEventListener('click', () => entry.remove());
    }

    function renderHistory() {
      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = '';
      workouts.forEach((w, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border px-4 py-2 align-top">${w.date}</td>
          <td class="border px-4 py-2 align-top">\${w.exercises.map(e => `<strong>\${e.name}</strong>: \${e.setsData.map(sd => sd.weight + 'x' + sd.reps).join(', ')}`).join('<br>')}
          </td>
          <td class="border px-4 py-2 align-top space-x-2">
            <button data-idx="${idx}" class="edit-btn bg-yellow-300 px-2 py-1 rounded">Edit</button>
            <button data-idx="${idx}" class="delete-btn bg-red-300 px-2 py-1 rounded">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => {
        const i = btn.dataset.idx;
        editKey = workoutKeys[i];
        const w = workouts[i];
        document.getElementById('addWorkoutForm').reset();
        document.getElementById('exerciseContainer').innerHTML = '';
        w.exercises.forEach(e => {
          addExerciseEntry();
          const last = document.querySelectorAll('.exercise-entry');
          const entry = last[last.length - 1];
          entry.querySelector('.exercise-name').value = e.name;
          entry.querySelector('.sets').value = e.setsData.length;
          entry.querySelector('.add-sets-btn').click();
          Array.from(entry.querySelectorAll('.set-entry')).forEach((se, idx2) => {
            se.querySelector('.reps').value = e.setsData[idx2].reps;
            se.querySelector('.weight').value = e.setsData[idx2].weight;
          });
        });
      }));
      document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', () => {
        const i = btn.dataset.idx;
        if (confirm('Delete this workout?')) db.ref(`workouts/${workoutKeys[i]}`).remove();
      }));
    }

    function renderPRs() {
      const prMap = {};
      workouts.forEach(w => w.exercises.forEach(e => e.setsData.forEach(sd => {
        if (!prMap[e.name] || sd.weight > prMap[e.name]) prMap[e.name] = sd.weight;
      })));
      const ul = document.getElementById('prList'); ul.innerHTML = '';
      for (const [name, wt] of Object.entries(prMap)) {
        const li = document.createElement('li'); li.textContent = `${name}: ${wt}`;
        ul.appendChild(li);
      }
    }

    function renderChart() {
      const ctx = document.getElementById('progressChart').getContext('2d');
      if (window.progressChart) window.progressChart.destroy();
      const labels = workouts.map(w => w.date);
      const data = workouts.map(w => w.exercises.reduce((sum, e) => sum + e.setsData.reduce((s, sd) => s + sd.weight * sd.reps, 0), 0));
      window.progressChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Total Volume', data }] },
        options: { scales: { x: { type: 'time', time: { unit: 'day' } } } }
      });
    }

    // Start with one entry
    addExerciseEntry();

    // Register Service Worker
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
  </script>
</body>
</html>
